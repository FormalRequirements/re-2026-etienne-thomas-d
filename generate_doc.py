import pandas as pd
import os
import sys
import datetime

# Configuration
EXCEL_PATH = os.path.join("source", "requirements_app_PEGS.xlsx")
OUTPUT_ADOC = "output.adoc"

def clean_text(text):
    if pd.isna(text):
        return ""
    # On √©chappe les caract√®res sp√©ciaux AsciiDoc si n√©cessaire, mais on garde les sauts de ligne
    return str(text).strip().replace("\n", " +\n")

def get_priority_icon(moscow):
    """Retourne une ic√¥ne ou un style selon la priorit√©"""
    m = str(moscow).upper().strip()
    if m == 'MUST':
        return "üî¥ *MUST*"
    elif m == 'SHOULD':
        return "üü† *SHOULD*"
    elif m == 'COULD':
        return "üü¢ *COULD*"
    elif m == 'WONT':
        return "‚ö™ *WON'T*"
    return m

def generate_asciidoc():
    print(f"üîç Recherche du fichier : {EXCEL_PATH}")
    
    if not os.path.exists(EXCEL_PATH):
        print(f"‚ùå Erreur : Fichier introuvable √† {EXCEL_PATH}")
        sys.exit(1)

    try:
        df = pd.read_excel(EXCEL_PATH)
        # On trie pour avoir un ordre logique : Cat√©gorie puis ID
        if 'ID' in df.columns and 'Category' in df.columns:
            df = df.sort_values(by=['Category', 'ID'])
    except Exception as e:
        print(f"‚ùå Erreur lecture Excel : {e}")
        sys.exit(1)

    # --- 1. EN-T√äTE (HEADER) ---
    # C'est ici qu'on d√©finit le style "Book" du template
    today = datetime.date.today()
    adoc_content = f"""= Project Requirements Document
:author: Generated by GitHub Actions
:revdate: {today}
:doctype: book
:toc: left
:toclevels: 3
:sectnums:
:sectnumlevels: 4
:icons: font
:experimental:
:source-highlighter: highlight.js
:imagesdir: images

// Introduction standard du template
== Introduction

Ce document contient les sp√©cifications du projet g√©n√©r√©es automatiquement.

[TIP]
====
Derni√®re mise √† jour : {today}
Source des donn√©es : `{os.path.basename(EXCEL_PATH)}`
====
"""

    # --- 2. G√âN√âRATION DU CONTENU ---
    
    # Groupement par Cat√©gorie (Project, System, Hardware, etc.)
    # Si la colonne n'existe pas, on met tout dans "General"
    if 'Category' not in df.columns:
        df['Category'] = 'General'

    for category, items in df.groupby('Category'):
        adoc_content += f"\n== {category}\n\n"
        
        for _, row in items.iterrows():
            req_id = clean_text(row.get('ID', 'REQ-???'))
            title = clean_text(row.get('Title', 'Sans titre'))
            moscow = clean_text(row.get('MoSCoW', ''))
            desc = clean_text(row.get('Description', ''))
            rationale = clean_text(row.get('Rationale', ''))
            accept_crit = clean_text(row.get('Acceptance Criteria', ''))
            status = clean_text(row.get('Status', ''))

            priority_display = get_priority_icon(moscow)
            
            # Structure "Exigence" propre
            adoc_content += f"=== {req_id}: {title}\n\n"
            
            # Bloc de m√©tadonn√©es (Tableau sans bordure ou Sidebar)
            adoc_content += f"**Priorit√©:** {priority_display} | **Statut:** `{status}`\n\n"
            
            # La description principale dans un bloc sidebar
            if desc:
                adoc_content += f".Description\n****\n{desc}\n****\n\n"
            
            # Justification en Note
            if rationale:
                adoc_content += f"[NOTE]\n.Justification\n====\n{rationale}\n====\n\n"
            
            # Crit√®res d'acceptation en exemple ou citation
            if accept_crit:
                adoc_content += f".Crit√®res d'acceptation\n[example]\n====\n{accept_crit}\n====\n\n"
            
            adoc_content += "---\n\n"

    # --- 3. √âCRITURE DU FICHIER ---
    with open(OUTPUT_ADOC, "w", encoding="utf-8") as f:
        f.write(adoc_content)
    
    print(f"üéâ Succ√®s : {OUTPUT_ADOC} g√©n√©r√© selon le template Book.")

if __name__ == "__main__":
    generate_asciidoc()